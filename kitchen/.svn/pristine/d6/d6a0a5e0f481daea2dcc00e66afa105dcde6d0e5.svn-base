<?php
	include("connectData.php");
	//Get status
	$status = (isset($_GET['status'])) ? $_GET['status'] : -1;
	if($status > -1){
		//bill id of show list
		$bill_id = $_GET['bill_id'];
		//food id of list item
		$food_id = $_GET['food_id'];
		
		
		connectdb();
		if($status == 0){
			mysql_query("UPDATE orders SET status = 1 WHERE bill_id = ".$bill_id." AND food_id = ".$food_id);
		}else{
			mysql_query("UPDATE orders SET status = 0 WHERE bill_id = ".$bill_id." AND food_id = ".$food_id);
		}
		mysql_close();
	}
	
	$enumData = getCommentCategories();
	$orders =GetOrdersByTime();
	
	$index = $_GET['index'];
	$item = $orders[$index];
	$foods = $item[3];
	$food_count = count($foods);
	if($food_count == 0){
	?>
		<script type="text/javascript">
			sessionStorage.curIndex = 0;
			updateSession();
			$('#item_0').css('color','#04B404');
		</script>
	<?php
		$index = 0;
		$item = $orders[$index];
		$foods = $item[3];
		$food_count = count($foods);
		
	}
	?>
	<div style="height: 40px; line-height:40px; 
		width: 100%; text-align:center; background-image: -webkit-linear-gradient( #626244, #1f1f0c ); background-image: -moz-linear-gradient( #626244, #1f1f0c ); color:#06ABCE; text-shadow:none;">

	<div style="clear:both"></div>
		<div style="text-align: center; width: 80%; float: left; margin-left: 8%"><?php echo $item[2]; ?></div>
		<?php
			$message = "";
			foreach($foods as $food){
				$message .= "  ".$food[1];
			}
		?>
		<a onclick="onFinish(<?php echo $item[0].",'".		//user_id
										$item[2]." ".		//table_name
										$item[4]." ".		//zone
										$message." đã hoàn thành!',".		//message
										$item[1].",".		//bill_id
										$item[5];			//table_id
										?>);" class="ui-link"><img src="images/bt_finish.png" style="cursor: pointer; float:right;"></a>
	
	</div> 
	
	<?php

	foreach( $foods as $food){	
	
	if($food[4] == 0){ //Queue
		$color = "#090";
		$image = "images/in_progress.png";
	}else{	//In Progress
		$color = "#FFBF00";
		$image = "images/queue.png";
	}
	?>
		
		<table class="itemListOrder" id="itemListOrder_<?php echo $item[1];?>_<?php echo $food[0];?>" style="background-color:<?php echo $color?>;">
			<tr valign="middle">
				<td width="15%" class="foodCount"><?php echo $food[3]; ?></td>
				<td width="40%" class="foodBlock">
					<p class="foodName"><?php echo $food[1]; ?></p>
					<p class="foodImage"><img src="../FoodImages/<?php echo $food[2]; ?>" alt="<?php echo $food[1]; ?>"></p>
				</td>	
									
				<td width="45%" class="comment" align="left" valign="top">
					<div style="float: right; margin-right: 45px;">
					<a onclick="onFinishFood(<?php echo $item[0].",'". 	//user_id
												$item[2]." ".			//table_name
												$item[4]." ".			//zone
												$food[1]." đã hoàn thành!',".			//food_name
												$item[1].",".   		//bill_id
												$food[0].",".			//food_id
												$item[5];				//table_id
											?>);" 
											class="buttonControl ui-link" style="background:url('images/check.png')"></a>
					
					<a id="toggleStatus_<?php echo $item[1];?>_<?php echo $food[0];?>" onclick="onToggleProgress(<?php echo $item[1].",".$food[0].",".$food[4];?>);" class="buttonControl ui-link" style="background:url('<?php echo $image;?>')"></a>
					</div>
					<br/><br/>
					<div class="clear"></div>
					<span>
					<?php
					if(count($food) > 6){
						$comment = str_replace(' ','',$food[5]);
						$arr = array();
							$str = array();
						$k = 0;
						while($k < strlen($comment)){
							if($comment{$k} == '['){
								$tmp = '';
							}	
							else if($comment{$k} == ']'){
								array_push($str,$tmp);
								array_push($arr, $str);
								$str = array();
							}	
							else if($comment{$k} == ','){
								array_push($str,$tmp);
								$tmp = '';
							}
							else
								$tmp .= $comment{$k};	
							$k++;
						}	
						
						$k = 0;
						while($k < count($arr)){
							$count = 1;
							$l = $k + 1;
							while($l < count($arr)){
								if($arr[$l] == $arr[$k]){
									$count++;
									unset($arr[$l]);
								}
								$l++;
							}
							
							//Print each comment for a food
							$m = 0;
							$str = "";
							
							while($m < count($arr[$k])-1){ //for comments in a food
								if(isset($enumData[$arr[$k][$m]]) && $enumData[$arr[$k][$m]] != "")
									$str .= $enumData[$arr[$k][$m]].", ";
								$m++;
							}
							if($k == count($arr)-1){
								if(isset($enumData[$arr[$k][$m]]) && $enumData[$arr[$k][$m]] != "")
									$str .= $enumData[$arr[$k][$m]];
							}else{				
								if(isset($enumData[$arr[$k][$m]]) && $enumData[$arr[$k][$m]] != "")
									$str .= $enumData[$arr[$k][$m]]."</span><span>";
							}
							
							//Print comment line
							if($str != "")
								echo "&nbsp;&nbsp;+&nbsp;&nbsp;".$count." ".$food[6]." ".$str;
							$arr = array_values($arr);
							$k++;
						}
					}else{
						echo "&nbsp;&nbsp;+&nbsp;&nbsp;Không có yêu cầu.";
					}
					?>
				</span>
				</td>
			</tr>	
		</table>
<?php } ?>
					
					
<script type="text/javascript">
	
	function onFinish(user_id, message, bill_id, table_id){
		if(confirm("Do you sure finished these foods?")){
			sessionStorage.curIndex = 0;
			websocketClient.onFinished(user_id, message, table_id);
			updateSession();
			$.ajax({
				type: 'POST',
				url: "php/container.php?bill_id="+bill_id+"&index="+0,
				data: null,
				success: function(result)
				{
					$('#container').html(result);
				},
				error: {
				}
			}); 
		}			
	}
	
	function onFinishFood(user_id, message, bill_id, food_id, table_id){
		if(confirm("Do you sure finished this food?")){
			sessionStorage.curIndex = <?php echo (($food_count > 1) ? $index : 0);?>;
			if(sessionStorage.curIndex == 0){
					
				updateSession();
				
			}
			websocketClient.onFinished(user_id, message, table_id);
			$.ajax({
				type: 'POST',
				url: "php/container.php?bill_id="+bill_id+"&food_id="+food_id+"&index="+sessionStorage.curIndex,
				data: null,
				success: function(result)
				{
					$('#container').html(result);
				},
				error: {
				}
			}); 
		}	
	}
	
	function onToggleProgress(bill_id, food_id, status){
		sessionStorage.curIndex = <?php echo $index;?>;
		websocketClient.onToggled(bill_id, food_id, status, <?php echo $index;?>);
	
		 
	}
	
	function updateSession(){
		var index = <?php echo $index; ?>;
		console.log(index);
		var items =  JSON.parse(sessionStorage.items);
		console.log(items);
		for(var i=0; i<items.length; i++){
			if(items[i] > index) {
				items[i]--;
			}
		}
		console.log(items);
		
		// storage Array new items
		sessionStorage.items = JSON.stringify(items);
	
	}
</script>					