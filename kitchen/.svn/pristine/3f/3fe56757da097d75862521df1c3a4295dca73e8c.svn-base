<div style="min-height: 350px;">
<?php
	include("connectData.php");
	//Get status
	$status = (isset($_GET['status'])) ? $_GET['status'] : -1;
	//food id of list item
	$food_id = (isset($_GET['food_id'])) ? $_GET['food_id'] : -1;
	if($status > -1){
		connectdb();
		if($status == 0 || $status == 99){
			mysql_query("UPDATE orders SET status = 1 WHERE food_id = ".$food_id);
		}else{
			mysql_query("UPDATE orders SET status = 0 WHERE food_id = ".$food_id);
		}
		mysql_close();
	}else if($food_id > -1){
		
		
		
		connectdb();
		mysql_query("UPDATE orders SET status = 2 WHERE food_id = ".$food_id);
		mysql_close();
	}
	
	$food_type = (isset($_GET['food_type'])) ? $_GET['food_type'] : 1;
	
	$enumData = getCommentCategories();
	$foods =GetOrdersByFood($food_type);
	
	
	?>
	<div style="height: 40px; line-height:40px; 
		width: 100%; text-align:center; background-image: -webkit-linear-gradient( #626244, #1f1f0c ); background-image: -moz-linear-gradient( #626244, #1f1f0c ); color:#06ABCE; text-shadow:none;">

	<div style="clear:both"></div>
		<div style="text-align: center; width: 80%; float: left; margin-left: 8%">Danh sách chế biến</div>
		<?php
			$message = $foods['food_count']." ".$foods['food_name']." đã hoàn thành!";
		?>
		
	
	</div> 
	
	
	<!--Menu-->
	<div id="menu_container">
		<?php 
		if($food_type == 1){
			echo '<span class="a_selected" id="bt_food" onclick="switchFoodType(1)">Món ăn</span>';
			echo '<span id="bt_drink" onclick="switchFoodType(2)">Đồ uống</span>';
			echo '<span id="bt_other" onclick="switchFoodType(3)">Khác</span>';
		}
		if($food_type == 2){
			echo '<span id="bt_food" onclick="switchFoodType(1)">Món ăn</span>';
			echo '<span class="a_selected" id="bt_drink" onclick="switchFoodType(2)">Đồ uống</span>';
			echo '<span id="bt_other" onclick="switchFoodType(3)">Khác</span>';
		}
		if($food_type == 3){
			echo '<span id="bt_food" onclick="switchFoodType(1)">Món ăn</span>';
			echo '<span id="bt_drink" onclick="switchFoodType(2)">Đồ uống</span>';
			echo '<span class="a_selected" id="bt_other" onclick="switchFoodType(3)">Khác</span>';
		}
		?>
	</div>
	
	
	<?php
	foreach( $foods as $food){	
	
	if($food['food_status'] == 0){ //Queue
		$color = "#090";
		$image = "images/in_progress.png";
	}else if($food['food_status'] == 1){ //In Progress
		$color = "#FFBF00";
		$image = "images/queue.png";
	}else{
		$color = "#DD0273";
		$image = "images/in_progress.png";
	}
	?>
		<table class="itemListOrder" id="itemListOrder_<?php echo $food['food_id'];?>" style="background-color:<?php echo $color ?>">
		
			<tr valign="middle">
				<td width="15%" class="foodCount"><?php echo $food['food_count']; ?></td>
				<td width="40%" class="foodBlock">
					<p class="foodName"><?php echo $food['food_name']; ?></p>
					<p class="foodImage"><img src="../FoodImages/<?php echo $food['food_image']; ?>" alt="<?php echo $food['food_name']; ?>"></p>
				</td>	
									
				<td width="45%" class="comment" align="left" valign="top">
					<div style="float: right;  margin-right: 45px;"">
					<a onclick="onFinishFoodFood(<?php echo $food['food_id'].",'".		//food_id
													$message."',".					//message
													$food['user_id'];				//user_id
											?>);" 
											class="buttonControl ui-link" style="background:url('images/check.png')"></a>
					
					<a id="toggleStatus_<?php echo $food['food_id'];?>" onclick="onToggleProgressFood(<?php echo $food['food_id'].",".$food['food_status'];?>);" class="buttonControl ui-link" style="background:url('<?php echo $image;?>')"></a>
					</div>
					<br/><br/>
					<div class="clear"></div>
					<span>
					<?php
					if(null != $food['food_comment']){
						$comment = str_replace(' ','',$food['food_comment']);
						$arr = array();
							$str = array();
						$k = 0;
						while($k < strlen($comment)){
							if($comment{$k} == '['){
								$tmp = '';
							}	
							else if($comment{$k} == ']'){
								array_push($str,$tmp);
								array_push($arr, $str);
								$str = array();
							}	
							else if($comment{$k} == ','){
								array_push($str,$tmp);
								$tmp = '';
							}
							else
								$tmp .= $comment{$k};	
							$k++;
						}	
						
						$k = 0;
						while($k < count($arr)){
							$count = 1;
							$l = $k + 1;
							while($l < count($arr)){
								if($arr[$l] == $arr[$k]){
									$count++;
									unset($arr[$l]);
								}
								$l++;
							}
							
							//Print each comment for a food
							$m = 0;
							$str = "";
							
							while($m < count($arr[$k])-1){ //for comments in a food
								if(isset($enumData[$arr[$k][$m]]) && $enumData[$arr[$k][$m]] != "")
									$str .= $enumData[$arr[$k][$m]].", ";
								$m++;
							}
							if($k == count($arr)-1){
								if(isset($enumData[$arr[$k][$m]]) && $enumData[$arr[$k][$m]] != "")
									$str .= $enumData[$arr[$k][$m]];
							}else{				
								if(isset($enumData[$arr[$k][$m]]) && $enumData[$arr[$k][$m]] != "")
									$str .= $enumData[$arr[$k][$m]]."</span><span>";
							}
							
							//Print comment line
							if($str != "")
								echo "&nbsp;&nbsp;+&nbsp;&nbsp;".$count." ".$food['food_unit']." ".$str;
							$arr = array_values($arr);
							$k++;
						}
					}else{
						echo "&nbsp;&nbsp;+&nbsp;&nbsp;Không có yêu cầu.";
					}
					?>
				</span>
				</td>
			</tr>	
		</table>
<?php } ?>
	

	

	
</div>					
					
<script type="text/javascript">

	function switchFoodType(food_type){
			
		$.ajax({
				type: 'POST',
				url: "php/sortByFood.php?&food_type="+food_type,
				data: null,
				success: function(result)
				{
					$('#container').html(result);
				},
				error: {
				}
			});
	}
	
	
	function onFinishFoodFood(food_id, message, user_id){
		if(confirm("Do you sure finished this food?")){
			websocketClient.onFinished(user_id, message, "");
			
			$.ajax({
				type: 'POST',
				url: "php/sortByFood.php?food_id="+food_id,
				data: null,
				success: function(result)
				{
					$('#container').html(result);
				},
				error: {
				}
			}); 
		}	
	}
	
	function onToggleProgressFood(food_id, status){
		$.ajax({
				type: 'POST',
				url: "php/sortByFood.php?food_id="+food_id+"&status="+status,
				data: null,
				success: function(result)
				{
					$('#container').html(result);
				},
				error: {
				}
			}); 
	}
</script>					